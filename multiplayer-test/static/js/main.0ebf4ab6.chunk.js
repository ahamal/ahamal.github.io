(window.webpackJsonp=window.webpackJsonp||[]).push([[0],[,,,,,,,,,,function(e,t,n){e.exports=n(28)},,,,,function(e,t,n){},,function(e,t,n){},,,function(e,t,n){},,function(e,t,n){},,function(e,t,n){},,function(e,t,n){},,function(e,t,n){"use strict";n.r(t);var i=n(1),a=n.n(i),r=n(9),o=n.n(r),s=(n(15),n(2)),c=n(3),u=n(5),l=n(4),f=n(6),p=(n(17),n(0)),d=n.n(p),h=(n(20),function(e){function t(){return Object(s.a)(this,t),Object(u.a)(this,Object(l.a)(t).apply(this,arguments))}return Object(f.a)(t,e),Object(c.a)(t,[{key:"render",value:function(){var e=this.props.value;return a.a.createElement("div",{className:"player-model",style:{top:e.y,left:e.x,background:e.color,transform:"rotate(".concat(e.r,"deg)")}},a.a.createElement("div",{style:{position:"relative"}},a.a.createElement("div",{className:"gun",style:{background:e.color}})))}}]),t}(a.a.Component)),m=(n(22),function(e){function t(){return Object(s.a)(this,t),Object(u.a)(this,Object(l.a)(t).apply(this,arguments))}return Object(f.a)(t,e),Object(c.a)(t,[{key:"render",value:function(){var e=this,t=this.props.frame;return a.a.createElement("div",{className:"scene",ref:function(t){return e.el=t},onMouseMove:function(t){e.mouseX=t.pageX-e.el.offsetLeft,e.mouseY=t.pageY-e.el.offsetTop},onMouseUp:this.props.onMouseUp,onMouseDown:this.props.onMouseDown},t&&d.a.map(t.players,function(e,t){return a.a.createElement(h,{key:t,value:e})}),this.props.debug&&this.debugC())}},{key:"debugC",value:function(){var e=this.props.ex;return a.a.createElement("div",{className:"debugger"},a.a.createElement("div",{className:"trails"},d.a.map(e.trails,function(t){return a.a.createElement("div",{className:"trail-dot"+(t.actionSetId===e.definitive.actionSetId?" definitive":""),key:t.timeStamp,style:{left:t.x+"px",top:t.y+"px"}})})),e.definitive&&a.a.createElement("div",{className:"definitive-dot",style:{left:e.definitive.x+"px",top:e.definitive.y+"px"}}))}}]),t}(a.a.Component)),v=function(){function e(){Object(s.a)(this,e),this.clients=["p1","p2"],this.p={p1:{},p2:{}},this.mouse={}}return Object(c.a)(e,[{key:"update",value:function(e){var t=this,n=e.frame,i=e.actionSets;return n=d.a.cloneDeep(n),d.a.each(i,function(e){var i=t.p[e.clientId];i.mouseX=e.mouseX,i.mouseY=e.mouseY,d.a.each(e.actions,function(e){"keyDown"===e.type?i[e.key]=!0:"keyUp"===e.type&&(i[e.key]=!1)}),n.actionSets[e.clientId]=e.id}),d.a.each(this.p,function(e,t){var i,a,r,o,s=n.players[t],c=e.left?-1:e.right?1:0,u=e.up?-1:e.down?1:0,l=10*(0!==c&&0!==u?.707:1);s.x+=c*l,s.y+=u*l,s.r=(i=s.x,a=s.y,r=e.mouseX||0,o=e.mouseY||0,(180*Math.atan2(o-a,r-i)/Math.PI-90)%360)}),n.timeStamp=new Date,n}}]),e}(),y=(n(24),function(e){function t(){var e;return Object(s.a)(this,t),(e=Object(u.a)(this,Object(l.a)(t).call(this))).update=function(){var t=e.actionsBuffer.splice(0,e.actionsBuffer.length),n=e.engine.update({frame:e.frame,actionSets:t});e.frame=n,e.forceUpdate()},e.send=function(){d.a.each(e.subscriptions,function(t,n){t(e.frame)})},e.onReceive=function(t,n){n.clientId=t,e.actionsBuffer.push(n)},e.getFrame=function(t,n){n(e.frame)},e.subscribe=function(t,n){e.subscriptions[t]=n},e.engine=new v,e.subscriptions={},e.actionsBuffer=[],e.frame={actionSets:{},players:{p1:{x:30,y:30,r:90,color:"green"},p2:{x:370,y:370,r:360,color:"cyan"}}},e.updateRate=30,e.sendRate=100,setInterval(e.update,e.updateRate),setInterval(e.send,e.sendRate),e}return Object(f.a)(t,e),Object(c.a)(t,[{key:"render",value:function(){return a.a.createElement("div",{className:"server"},a.a.createElement("div",null,"Server"),a.a.createElement(m,{frame:this.frame}))}}]),t}(a.a.Component)),g=function(){function e(t){var n=this,i=t.interpolationDelay,a=t.updateRate,r=t.id;Object(s.a)(this,e),this.onServerFrame=function(e){n.definitiveFrame=e,n.frameBuffer.unshift(e),n.frameBuffer.pop(),n.predictionFrame||(n.predictionFrame=d.a.cloneDeep(n.definitiveFrame)),n.verifyPrediction()},this.getDisplayFrame=function(){return n.combine(n.getInterpolated(),n.getPredicted())},this.getInterpolated=function(){var e=n.frameBuffer,t=new Date-n.interpolationDelay,i=d.a.findIndex(e,function(e){return t>e.receiveTime},1);if(-1!==i){var a=e[i],r=e[i-1],o=(t-a.receiveTime)/(r.receiveTime-a.receiveTime);return n.interpolate(a,r,o)}},this.update=function(){if(n.predictionFrame){var e=n.actionSetBuffer.splice(0,n.actionSetBuffer.length);n.predictionFrame=n.engine.update({frame:n.predictionFrame,actionSets:e}),n.logTrails()}},this.id=r,this.interpolationDelay=i,this.updateRate=a,this.frameBuffer=[0,0,0,0,0],this.actionSetBuffer=[],this.engine=new v,this.errorSmoothing=.3,this.interpolationFields=["players.p1.x","players.p1.y","players.p1.r","players.p2.x","players.p2.y","players.p2.r"],this.predictionFields=["players.".concat(r,".x"),"players.".concat(r,".y"),"players.".concat(r,".r")],this.updateInterval=setInterval(this.update,this.updateRate),this.trails=[]}return Object(c.a)(e,[{key:"interpolate",value:function(e,t,n){var i=d.a.cloneDeep(e);return this.interpolationFields.forEach(function(a){var r=d.a.get(e,a),o=d.a.get(t,a);r&&o&&d.a.set(i,a,r+(o-r)*n)}),i}},{key:"combine",value:function(e,t){if(e){if(!t)return e;var n=e;return this.predictionFields.forEach(function(e){d.a.set(n,e,d.a.cloneDeep(d.a.get(t,e)))}),n}}},{key:"onActionSet",value:function(e){this.actionSetBuffer.push(e)}},{key:"getPredicted",value:function(){return this.predictionFrame}},{key:"logTrails",value:function(){this.trails.push({x:d.a.get(this.predictionFrame,"players.".concat(this.id,".x")),y:d.a.get(this.predictionFrame,"players.".concat(this.id,".y")),actionSetId:d.a.get(this.predictionFrame,"actionSets.".concat(this.id)),timeStamp:(new Date).getTime()})}},{key:"verifyPrediction",value:function(){var e=this,t=this.predictionFrame,n=this.trails;this.definitive={x:d.a.get(this.definitiveFrame,"players.".concat(this.id,".x")),y:d.a.get(this.definitiveFrame,"players.".concat(this.id,".y")),actionSetId:d.a.get(this.definitiveFrame,"actionSets.".concat(this.id))};var i=d.a.findLastIndex(n,function(t){return t.actionSetId===e.definitive.actionSetId});n.splice(0,i);var a=n[0];if(a){var r=(this.definitive.x-a.x)*this.errorSmoothing,o=(this.definitive.y-a.y)*this.errorSmoothing;d.a.each(n,function(e){e.x+=r,e.y+=o}),d.a.set(t,"players.".concat(this.id,".x"),d.a.get(t,"players.".concat(this.id,".x"))+r),d.a.set(t,"players.".concat(this.id,".y"),d.a.get(t,"players.".concat(this.id,".y"))+o)}}}]),e}(),b=(n(26),function(e){function t(e){var n;return Object(s.a)(this,t),(n=Object(u.a)(this,Object(l.a)(t).call(this))).onKeyDown=function(e){if(!n.pressedKeys[e.key]){n.pressedKeys[e.key]=!0;var t=n.props.controls[e.key];t&&n.onAction({type:"keyDown",key:t,id:n.actionIdCounter++,timeStamp:new Date})}},n.onKeyUp=function(e){n.pressedKeys[e.key]=!1;var t=n.props.controls[e.key];t&&n.onAction({type:"keyUp",key:t,id:n.actionIdCounter++,timeStamp:new Date})},n.onSceneMouse=function(e){n.onAction({type:"mouseDown",bool:e,mouseX:n.scene.mouseX,mouseY:n.scene.mouseY,id:n.actionIdCounter++,timeStamp:new Date})},n.onAction=function(e){n.actionsBuffer.push(e)},n.send=function(){var e=n.actionsBuffer.splice(0,n.actionsBuffer.length),t={clientId:n.id,id:n.actionSetCounter++,actions:e.length>0&&e,mouseX:n.scene.mouseX,mouseY:n.scene.mouseY};n.sendToServer(t),n.ex.onActionSet(t)},n.sendToServer=function(e){setTimeout(function(t){return n.server.onReceive(n.id,e)},n.lag)},n.onServerData=function(e){setTimeout(function(t){return n.onReceive(e)},n.lag)},n.onReceive=function(e){(e=d.a.cloneDeep(e)).receiveTime=new Date,n.ex.onServerFrame(e)},n.refresh=function(){n.displayFrame=n.ex.getDisplayFrame(),n.forceUpdate()},n.id=e.id,n.lag=100,n.sendRate=100,n.frameRate=30,n.controls=e.controls,n.actionsBuffer=[],n.actionIdCounter=0,n.actionSetCounter=0,n.interpolationDelay=250,n.ex=new g({interpolationDelay:n.interpolationDelay,updateRate:30,id:n.id}),n}return Object(f.a)(t,e),Object(c.a)(t,[{key:"componentDidMount",value:function(){this.pressedKeys={},window.document.addEventListener("keydown",this.onKeyDown),window.document.addEventListener("keyup",this.onKeyUp)}},{key:"connect",value:function(e){this.server=e,e.subscribe(this.id,this.onServerData),this.sendInterval=setInterval(this.send,this.sendRate),this.refreshInterval=setInterval(this.refresh,this.frameRate)}},{key:"render",value:function(){var e=this;return a.a.createElement("div",{className:"client"},a.a.createElement("div",null,"Client ",this.id),a.a.createElement(m,{ref:function(t){return e.scene=t},frame:this.displayFrame,onMouseDown:function(t){return e.onSceneMouse(!0)},onMouseUp:function(t){return e.onSceneMouse(!1)},ex:this.ex,debug:!0}))}}]),t}(a.a.Component)),S=function(e){function t(){return Object(s.a)(this,t),Object(u.a)(this,Object(l.a)(t).apply(this,arguments))}return Object(f.a)(t,e),Object(c.a)(t,[{key:"render",value:function(){var e=this;return a.a.createElement("div",null,a.a.createElement(b,{id:"p1",controls:{ArrowUp:"up",ArrowDown:"down",ArrowLeft:"left",ArrowRight:"right"},ref:function(t){return e.client1=t}}),a.a.createElement(y,{ref:function(t){return e.server=t}}),a.a.createElement(b,{id:"p2",controls:{w:"up",s:"down",a:"left",d:"right"},ref:function(t){return e.client2=t}}))}},{key:"componentDidMount",value:function(){this.client1.connect(this.server),this.client2.connect(this.server)}}]),t}(a.a.Component);o.a.render(a.a.createElement(S,null),document.getElementById("root"))}],[[10,2,1]]]);
//# sourceMappingURL=main.0ebf4ab6.chunk.js.map